

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sphinx.writers.latex &mdash; Sphinx Skeleton</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Sphinx Skeleton" href="../../../index.html"/>
        <link rel="up" title="sphinx" href="../../sphinx.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Sphinx Skeleton
          

          
          </a>

          
            
            
              <div class="version">
                1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../generated/sphinx.html">1. Sphinx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinx.themes.html">2. sphinx/themes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinx.ext.html">3. <code class="docutils literal"><span class="pre">sphinx.ext</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinx.builders.html">4. <code class="docutils literal"><span class="pre">sphinx.builders</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinx.domains.html">5. <code class="docutils literal"><span class="pre">sphinx.domains</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../generated/sphinx.util.html">6. sphinx.util</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinx.websupport.html">7. sphinx.websupport</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../sphinx.misc.html">8. misc modules</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Sphinx Skeleton</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          













<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../sphinx.html">sphinx</a> &raquo;</li>
        
      <li>sphinx.writers.latex</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sphinx.writers.latex</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sphinx.writers.latex</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    Custom docutils writer for LaTeX.</span>

<span class="sd">    Much of this code is adapted from Dave Kuhlman&#39;s &quot;docpy&quot; writer from his</span>
<span class="sd">    docutils sandbox.</span>

<span class="sd">    :copyright: Copyright 2007-2016 by the Sphinx team, see AUTHORS.</span>
<span class="sd">    :license: BSD, see LICENSE for details.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="kn">import</span> <span class="n">itervalues</span><span class="p">,</span> <span class="n">text_type</span>
<span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">writers</span>
<span class="kn">from</span> <span class="nn">docutils.writers.latex2e</span> <span class="kn">import</span> <span class="n">Babel</span>

<span class="kn">from</span> <span class="nn">sphinx</span> <span class="kn">import</span> <span class="n">addnodes</span>
<span class="kn">from</span> <span class="nn">sphinx</span> <span class="kn">import</span> <span class="n">highlighting</span>
<span class="kn">from</span> <span class="nn">sphinx.errors</span> <span class="kn">import</span> <span class="n">SphinxError</span>
<span class="kn">from</span> <span class="nn">sphinx.locale</span> <span class="kn">import</span> <span class="n">admonitionlabels</span><span class="p">,</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">sphinx.util</span> <span class="kn">import</span> <span class="n">split_into</span>
<span class="kn">from</span> <span class="nn">sphinx.util.nodes</span> <span class="kn">import</span> <span class="n">clean_astext</span>
<span class="kn">from</span> <span class="nn">sphinx.util.osutil</span> <span class="kn">import</span> <span class="n">ustrftime</span>
<span class="kn">from</span> <span class="nn">sphinx.util.texescape</span> <span class="kn">import</span> <span class="n">tex_escape_map</span><span class="p">,</span> <span class="n">tex_replace_map</span>
<span class="kn">from</span> <span class="nn">sphinx.util.smartypants</span> <span class="kn">import</span> <span class="n">educate_quotes_latex</span>

<span class="n">HEADER</span> <span class="o">=</span> <span class="s1">r&#39;&#39;&#39;</span><span class="si">%%</span><span class="s1"> Generated by Sphinx.</span>
<span class="s1">\def\sphinxdocclass{</span><span class="si">%(docclass)s</span><span class="s1">}</span>
<span class="s1">\documentclass[</span><span class="si">%(papersize)s</span><span class="s1">,</span><span class="si">%(pointsize)s%(classoptions)s</span><span class="s1">]{</span><span class="si">%(wrapperclass)s</span><span class="s1">}</span>
<span class="si">%(inputenc)s</span><span class="s1"></span>
<span class="si">%(utf8extra)s</span><span class="s1"></span>
<span class="si">%(cmappkg)s</span><span class="s1"></span>
<span class="si">%(fontenc)s</span><span class="s1"></span>
<span class="si">%(babel)s</span><span class="s1"></span>
<span class="si">%(fontpkg)s</span><span class="s1"></span>
<span class="si">%(fncychap)s</span><span class="s1"></span>
<span class="si">%(longtable)s</span><span class="s1"></span>
<span class="s1">\usepackage{sphinx}</span>
<span class="s1">\usepackage{multirow}</span>
<span class="s1">\usepackage{eqparbox}</span>
<span class="si">%(usepackages)s</span><span class="s1"></span>
<span class="si">%(contentsname)s</span><span class="s1"></span>
<span class="si">%(numfig_format)s</span><span class="s1"></span>
<span class="si">%(preamble)s</span><span class="s1"></span>

<span class="s1">\title{</span><span class="si">%(title)s</span><span class="s1">}</span>
<span class="s1">\date{</span><span class="si">%(date)s</span><span class="s1">}</span>
<span class="s1">\release{</span><span class="si">%(release)s</span><span class="s1">}</span>
<span class="s1">\author{</span><span class="si">%(author)s</span><span class="s1">}</span>
<span class="s1">\newcommand{\sphinxlogo}{</span><span class="si">%(logo)s</span><span class="s1">}</span>
<span class="s1">\renewcommand{\releasename}{</span><span class="si">%(releasename)s</span><span class="s1">}</span>
<span class="si">%(tocdepth)s</span><span class="s1"></span>
<span class="si">%(makeindex)s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">BEGIN_DOC</span> <span class="o">=</span> <span class="s1">r&#39;&#39;&#39;</span>
<span class="s1">\begin{document}</span>
<span class="si">%(shorthandoff)s</span><span class="s1"></span>
<span class="si">%(maketitle)s</span><span class="s1"></span>
<span class="si">%(tableofcontents)s</span><span class="s1"></span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">FOOTER</span> <span class="o">=</span> <span class="s1">r&#39;&#39;&#39;</span>
<span class="s1">\renewcommand{\indexname}{</span><span class="si">%(indexname)s</span><span class="s1">}</span>
<span class="si">%(printindex)s</span><span class="s1"></span>
<span class="s1">\end{document}</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">URI_SCHEMES</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;mailto:&#39;</span><span class="p">,</span> <span class="s1">&#39;http:&#39;</span><span class="p">,</span> <span class="s1">&#39;https:&#39;</span><span class="p">,</span> <span class="s1">&#39;ftp:&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">collected_footnote</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">footnote</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Footnotes that are collected are assigned this class.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">UnsupportedError</span><span class="p">(</span><span class="n">SphinxError</span><span class="p">):</span>
    <span class="n">category</span> <span class="o">=</span> <span class="s1">&#39;Markup is unsupported in LaTeX&#39;</span>


<div class="viewcode-block" id="LaTeXWriter"><a class="viewcode-back" href="../../../generated/generated/sphinx.builders.latex.LaTeXWriter.html#sphinx.builders.latex.LaTeXWriter">[docs]</a><span class="k">class</span> <span class="nc">LaTeXWriter</span><span class="p">(</span><span class="n">writers</span><span class="o">.</span><span class="n">Writer</span><span class="p">):</span>

    <span class="n">supported</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;sphinxlatex&#39;</span><span class="p">,)</span>

    <span class="n">settings_spec</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;LaTeX writer options&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;Document name&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;--docname&#39;</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;Document class&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;--docclass&#39;</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;manual&#39;</span><span class="p">}),</span>
        <span class="p">(</span><span class="s1">&#39;Author&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;--author&#39;</span><span class="p">],</span> <span class="p">{</span><span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">}),</span>
    <span class="p">))</span>
    <span class="n">settings_defaults</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">output</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="LaTeXWriter.__init__"><a class="viewcode-back" href="../../../generated/generated/sphinx.builders.latex.LaTeXWriter.__init__.html#sphinx.builders.latex.LaTeXWriter.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>
        <span class="n">writers</span><span class="o">.</span><span class="n">Writer</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translator_class</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">translator_class</span> <span class="ow">or</span> <span class="n">LaTeXTranslator</span><span class="p">)</span></div>

<div class="viewcode-block" id="LaTeXWriter.translate"><a class="viewcode-back" href="../../../generated/generated/sphinx.builders.latex.LaTeXWriter.translate.html#sphinx.builders.latex.LaTeXWriter.translate">[docs]</a>    <span class="k">def</span> <span class="nf">translate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">transform</span> <span class="o">=</span> <span class="n">ShowUrlsTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">)</span>
        <span class="n">transform</span><span class="o">.</span><span class="n">apply</span><span class="p">()</span>
        <span class="n">visitor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">translator_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">walkabout</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span></div></div>


<span class="c1"># Helper classes</span>

<span class="k">class</span> <span class="nc">ExtBabel</span><span class="p">(</span><span class="n">Babel</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get_shorthandoff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shortlang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">shortlang</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;de&#39;</span><span class="p">,</span> <span class="s1">&#39;ngerman&#39;</span><span class="p">,</span> <span class="s1">&#39;sl&#39;</span><span class="p">,</span> <span class="s1">&#39;slovene&#39;</span><span class="p">,</span> <span class="s1">&#39;pt&#39;</span><span class="p">,</span> <span class="s1">&#39;portuges&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;es&#39;</span><span class="p">,</span> <span class="s1">&#39;spanish&#39;</span><span class="p">,</span> <span class="s1">&#39;nl&#39;</span><span class="p">,</span> <span class="s1">&#39;dutch&#39;</span><span class="p">,</span> <span class="s1">&#39;pl&#39;</span><span class="p">,</span> <span class="s1">&#39;polish&#39;</span><span class="p">,</span> <span class="s1">&#39;it&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;italian&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">shorthandoff{&quot;}&#39;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">uses_cyrillic</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">shortlang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">language</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">shortlang</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;bg&#39;</span><span class="p">,</span> <span class="s1">&#39;bulgarian&#39;</span><span class="p">,</span> <span class="s1">&#39;kk&#39;</span><span class="p">,</span> <span class="s1">&#39;kazakh&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;mn&#39;</span><span class="p">,</span> <span class="s1">&#39;mongolian&#39;</span><span class="p">,</span> <span class="s1">&#39;ru&#39;</span><span class="p">,</span> <span class="s1">&#39;russian&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;uk&#39;</span><span class="p">,</span> <span class="s1">&#39;ukrainian&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ShowUrlsTransform</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">expanded</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span> <span class="o">=</span> <span class="n">document</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># replace id_prefix temporarily</span>
        <span class="n">id_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">id_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">id_prefix</span> <span class="o">=</span> <span class="s1">&#39;show_urls&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expand_show_urls</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">expanded</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">renumber_footnotes</span><span class="p">()</span>

        <span class="c1"># restore id_prefix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">id_prefix</span> <span class="o">=</span> <span class="n">id_prefix</span>

    <span class="k">def</span> <span class="nf">expand_show_urls</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">show_urls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_show_urls</span>
        <span class="k">if</span> <span class="n">show_urls</span> <span class="ow">is</span> <span class="bp">False</span> <span class="ow">or</span> <span class="n">show_urls</span> <span class="o">==</span> <span class="s1">&#39;no&#39;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">):</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refuri&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">URI_SCHEMES</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;mailto:&#39;</span><span class="p">):</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">uri</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span> <span class="o">!=</span> <span class="n">uri</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">show_urls</span> <span class="o">==</span> <span class="s1">&#39;footnote&#39;</span><span class="p">:</span>
                        <span class="n">footnote_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_footnote</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">footnote_nodes</span><span class="p">):</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">expanded</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># all other true values (b/w compat)</span>
                        <span class="n">textnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s2">&quot; (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">uri</span><span class="p">)</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">textnode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_footnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uri</span><span class="p">):</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">()</span>
        <span class="n">para</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>
        <span class="n">footnote</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">footnote</span><span class="p">(</span><span class="n">uri</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">para</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">footnote</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_autofootnote</span><span class="p">(</span><span class="n">footnote</span><span class="p">)</span>

        <span class="n">label</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="n">footnote_ref</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">footnote_reference</span><span class="p">(</span><span class="s1">&#39;[#]_&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                                <span class="n">refid</span><span class="o">=</span><span class="n">footnote</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">note_autofootnote_ref</span><span class="p">(</span><span class="n">footnote_ref</span><span class="p">)</span>
        <span class="n">footnote</span><span class="o">.</span><span class="n">add_backref</span><span class="p">(</span><span class="n">footnote_ref</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">footnote</span><span class="p">,</span> <span class="n">footnote_ref</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">renumber_footnotes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">is_used_number</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">footnote</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">number</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="bp">True</span>

            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">def</span> <span class="nf">is_auto_footnote</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">footnote</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">footnote_ref_by</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">is_footnote_ref</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">footnote_reference</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">is_footnote_ref</span>

        <span class="n">startnum</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">footnote</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">is_auto_footnote</span><span class="p">):</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">startnum</span><span class="p">)</span>
                <span class="n">startnum</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">is_used_number</span><span class="p">(</span><span class="n">label</span><span class="p">):</span>
                    <span class="k">break</span>

            <span class="n">old_label</span> <span class="o">=</span> <span class="n">footnote</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
            <span class="n">footnote</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">footnote</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">footnote</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">label</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">old_label</span> <span class="ow">in</span> <span class="n">footnote</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]:</span>
                <span class="n">footnote</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">old_label</span><span class="p">)</span>
            <span class="n">footnote</span><span class="p">[</span><span class="s1">&#39;names&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">footnote_ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">footnote_ref_by</span><span class="p">(</span><span class="n">footnote</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">])):</span>
                <span class="n">footnote_ref</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">footnote_ref</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">footnote_ref</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Table</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colspec</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">had_head</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_verbatim</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">longtable</span> <span class="o">=</span> <span class="bp">False</span>


<span class="k">class</span> <span class="nc">LaTeXTranslator</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="p">):</span>
    <span class="n">sectionnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;part&quot;</span><span class="p">,</span> <span class="s2">&quot;chapter&quot;</span><span class="p">,</span> <span class="s2">&quot;section&quot;</span><span class="p">,</span> <span class="s2">&quot;subsection&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;subsubsection&quot;</span><span class="p">,</span> <span class="s2">&quot;paragraph&quot;</span><span class="p">,</span> <span class="s2">&quot;subparagraph&quot;</span><span class="p">]</span>

    <span class="n">ignore_missing_images</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="n">default_elements</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;papersize&#39;</span><span class="p">:</span>       <span class="s1">&#39;letterpaper&#39;</span><span class="p">,</span>
        <span class="s1">&#39;pointsize&#39;</span><span class="p">:</span>       <span class="s1">&#39;10pt&#39;</span><span class="p">,</span>
        <span class="s1">&#39;classoptions&#39;</span><span class="p">:</span>    <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;extraclassoptions&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;inputenc&#39;</span><span class="p">:</span>        <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[utf8]{inputenc}&#39;</span><span class="p">,</span>
        <span class="s1">&#39;utf8extra&#39;</span><span class="p">:</span>       <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">DeclareUnicodeCharacter{00A0}{</span><span class="se">\\</span><span class="s1">nobreakspace}&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cmappkg&#39;</span><span class="p">:</span>         <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage{cmap}&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontenc&#39;</span><span class="p">:</span>         <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[T1]{fontenc}&#39;</span><span class="p">,</span>
        <span class="s1">&#39;babel&#39;</span><span class="p">:</span>           <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage{babel}&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fontpkg&#39;</span><span class="p">:</span>         <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage{times}&#39;</span><span class="p">,</span>
        <span class="s1">&#39;fncychap&#39;</span><span class="p">:</span>        <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[Bjarne]{fncychap}&#39;</span><span class="p">,</span>
        <span class="s1">&#39;longtable&#39;</span><span class="p">:</span>       <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage{longtable}&#39;</span><span class="p">,</span>
        <span class="s1">&#39;usepackages&#39;</span><span class="p">:</span>     <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;numfig_format&#39;</span><span class="p">:</span>   <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;contentsname&#39;</span><span class="p">:</span>    <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;preamble&#39;</span><span class="p">:</span>        <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;title&#39;</span><span class="p">:</span>           <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;date&#39;</span><span class="p">:</span>            <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;release&#39;</span><span class="p">:</span>         <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;author&#39;</span><span class="p">:</span>          <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;logo&#39;</span><span class="p">:</span>            <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;releasename&#39;</span><span class="p">:</span>     <span class="s1">&#39;Release&#39;</span><span class="p">,</span>
        <span class="s1">&#39;makeindex&#39;</span><span class="p">:</span>       <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">makeindex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;shorthandoff&#39;</span><span class="p">:</span>    <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;maketitle&#39;</span><span class="p">:</span>       <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">maketitle&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tableofcontents&#39;</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">tableofcontents&#39;</span><span class="p">,</span>
        <span class="s1">&#39;footer&#39;</span><span class="p">:</span>          <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;printindex&#39;</span><span class="p">:</span>      <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">printindex&#39;</span><span class="p">,</span>
        <span class="s1">&#39;transition&#39;</span><span class="p">:</span>      <span class="s1">&#39;</span><span class="se">\n\n\\</span><span class="s1">bigskip</span><span class="se">\\</span><span class="s1">hrule{}</span><span class="se">\\</span><span class="s1">bigskip</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span>
        <span class="s1">&#39;figure_align&#39;</span><span class="p">:</span>    <span class="s1">&#39;htbp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tocdepth&#39;</span><span class="p">:</span>        <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># sphinx specific document classes</span>
    <span class="n">docclasses</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;howto&#39;</span><span class="p">,</span> <span class="s1">&#39;manual&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">NodeVisitor</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># sort out some elements</span>
        <span class="n">papersize</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_paper_size</span> <span class="o">+</span> <span class="s1">&#39;paper&#39;</span>
        <span class="k">if</span> <span class="n">papersize</span> <span class="o">==</span> <span class="s1">&#39;paper&#39;</span><span class="p">:</span>  <span class="c1"># e.g. command line &quot;-D latex_paper_size=&quot;</span>
            <span class="n">papersize</span> <span class="o">=</span> <span class="s1">&#39;letterpaper&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_elements</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;wrapperclass&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_docclass</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">docclass</span><span class="p">),</span>
            <span class="s1">&#39;papersize&#39;</span><span class="p">:</span>    <span class="n">papersize</span><span class="p">,</span>
            <span class="s1">&#39;pointsize&#39;</span><span class="p">:</span>    <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_font_size</span><span class="p">,</span>
            <span class="c1"># if empty, the title is set to the first section title</span>
            <span class="s1">&#39;title&#39;</span><span class="p">:</span>        <span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
            <span class="s1">&#39;release&#39;</span><span class="p">:</span>      <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">release</span><span class="p">,</span>
            <span class="s1">&#39;author&#39;</span><span class="p">:</span>       <span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">author</span><span class="p">,</span>
            <span class="s1">&#39;releasename&#39;</span><span class="p">:</span>  <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Release&#39;</span><span class="p">),</span>
            <span class="s1">&#39;preamble&#39;</span><span class="p">:</span>     <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_preamble</span><span class="p">,</span>
            <span class="s1">&#39;indexname&#39;</span><span class="p">:</span>    <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Index&#39;</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="k">if</span> <span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">docclass</span> <span class="o">==</span> <span class="s1">&#39;howto&#39;</span><span class="p">:</span>
            <span class="n">docclass</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_docclass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;howto&#39;</span><span class="p">,</span> <span class="s1">&#39;article&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">docclass</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_docclass</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;manual&#39;</span><span class="p">,</span> <span class="s1">&#39;report&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;docclass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">docclass</span>
        <span class="k">if</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">today</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">today</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ustrftime</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">today_fmt</span> <span class="ow">or</span>
                                              <span class="n">_</span><span class="p">(</span><span class="s1">&#39;%B </span><span class="si">%d</span><span class="s1">, %Y&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_logo</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;logo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">includegraphics{</span><span class="si">%s</span><span class="s1">}</span><span class="se">\\</span><span class="s1">par&#39;</span> <span class="o">%</span> \
                                    <span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_logo</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
            <span class="n">babel</span> <span class="o">=</span> <span class="n">ExtBabel</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">get_language</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">lang</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;classoptions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="n">babel</span><span class="o">.</span><span class="n">get_language</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;no Babel option known for language </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span>
                                  <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">language</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;shorthandoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">babel</span><span class="o">.</span><span class="n">get_shorthandoff</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;fncychap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[Sonny]{fncychap}&#39;</span>

            <span class="c1"># Times fonts don&#39;t work with Cyrillic languages</span>
            <span class="k">if</span> <span class="n">babel</span><span class="o">.</span><span class="n">uses_cyrillic</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;fontpkg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

            <span class="c1"># pTeX (Japanese TeX) for support</span>
            <span class="k">if</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">language</span> <span class="o">==</span> <span class="s1">&#39;ja&#39;</span><span class="p">:</span>
                <span class="c1"># use dvipdfmx as default class option in Japanese</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;classoptions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;,dvipdfmx&#39;</span>
                <span class="c1"># disable babel which has not publishing quality in Japanese</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;babel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="c1"># disable fncychap in Japanese documents</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;fncychap&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;classoptions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,english&#39;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="s1">&#39;usepackages&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">declare_package</span><span class="p">(</span><span class="n">packagename</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">options</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage[</span><span class="si">%s</span><span class="s1">]{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">packagename</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">usepackage{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">packagename</span><span class="p">,)</span>
            <span class="n">usepackages</span> <span class="o">=</span> <span class="p">(</span><span class="n">declare_package</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">builder</span><span class="o">.</span><span class="n">usepackages</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;usepackages&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">usepackages</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;contentsname&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;contentsname&#39;</span><span class="p">]</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">babel_renewcommand</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">contentsname&#39;</span><span class="p">,</span>
                                        <span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">contentsname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;numfig_format&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_numfig_format</span><span class="p">(</span><span class="n">builder</span><span class="p">)</span>
        <span class="c1"># allow the user to override them all</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_elements</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;extraclassoptions&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;classoptions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> \
                                             <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;extraclassoptions&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">document</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tocdepth&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">docclass</span> <span class="o">==</span> <span class="s1">&#39;howto&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;tocdepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">setcounter{tocdepth}{</span><span class="si">%d</span><span class="s1">}&#39;</span> <span class="o">%</span>
                                             <span class="n">document</span><span class="p">[</span><span class="s1">&#39;tocdepth&#39;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;tocdepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">setcounter{tocdepth}{</span><span class="si">%d</span><span class="s1">}&#39;</span> <span class="o">%</span>
                                             <span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s1">&#39;tocdepth&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">highlighter</span> <span class="o">=</span> <span class="n">highlighting</span><span class="o">.</span><span class="n">PygmentsBridge</span><span class="p">(</span>
            <span class="s1">&#39;latex&#39;</span><span class="p">,</span>
            <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">pygments_style</span><span class="p">,</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trim_doctest_flags</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">descstack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibitems</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_table_colspec</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># stack of [language, linenothreshold] settings per file</span>
        <span class="c1"># the first item here is the default and must not be changed</span>
        <span class="c1"># the second item is the default for the master file and can be changed</span>
        <span class="c1"># by .. highlight:: directive in the master file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlsettingstack</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">[[</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highlight_language</span><span class="p">,</span>
                                    <span class="n">sys</span><span class="o">.</span><span class="n">maxsize</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bodystack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotestack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnote_restricted</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pending_footnotes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handled_abbrs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">document</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">docclass</span> <span class="o">==</span> <span class="s1">&#39;howto&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">top_sectionlevel</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_use_parts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">top_sectionlevel</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">top_sectionlevel</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_section_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_figure_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_table_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_literal_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c1"># flags</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_production_list</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_footnote</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_caption</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_container_literal_block</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_term</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_merged_cell</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_document</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">this_is_the_title</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">literal_whitespace</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compact_list</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_param</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirow</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">pushbody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newbody</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bodystack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">newbody</span>

    <span class="k">def</span> <span class="nf">popbody</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bodystack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">body</span>

    <span class="k">def</span> <span class="nf">restrict_footnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnote_restricted</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">footnote_restricted</span> <span class="o">=</span> <span class="n">node</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_footnotes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">unrestrict_footnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnote_restricted</span> <span class="o">==</span> <span class="n">node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">footnote_restricted</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">footnode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_footnotes</span><span class="p">:</span>
                <span class="n">footnode</span><span class="p">[</span><span class="s1">&#39;footnotetext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">footnode</span><span class="o">.</span><span class="n">walkabout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_footnotes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">format_docclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docclass</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; prepends prefix to sphinx document classes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">docclass</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">docclasses</span><span class="p">:</span>
            <span class="n">docclass</span> <span class="o">=</span> <span class="s1">&#39;sphinx&#39;</span> <span class="o">+</span> <span class="n">docclass</span>
        <span class="k">return</span> <span class="n">docclass</span>

    <span class="k">def</span> <span class="nf">astext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">HEADER</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span> <span class="o">+</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">highlighter</span><span class="o">.</span><span class="n">get_stylesheet</span><span class="p">()</span> <span class="o">+</span>
                <span class="s1">u&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">)</span> <span class="o">+</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;footer&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generate_indices</span><span class="p">()</span> <span class="o">+</span>
                <span class="n">FOOTER</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hypertarget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">,</span> <span class="n">withdoc</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">withdoc</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="nb">id</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">anchor</span> <span class="ow">and</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">phantomsection&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> \
            <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">label{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">idescape</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hyperlink</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">hyperref[</span><span class="si">%s</span><span class="s1">]{&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperrefescape</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hyperpageref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">autopageref*{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">idescape</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">idescape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">text_type</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_replace_map</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;backslashreplace&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">)</span><span class="o">.</span>\
            <span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hyperrefescape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">idescape</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">string-&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">babel_renewcommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">definition</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">language</span> <span class="o">==</span> <span class="s1">&#39;ja&#39;</span><span class="p">:</span>
            <span class="n">babel_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">babel_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
                <span class="n">language</span> <span class="o">=</span> <span class="n">ExtBabel</span><span class="p">(</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">language</span><span class="p">)</span><span class="o">.</span><span class="n">get_language</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">language</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">language</span> <span class="o">=</span> <span class="s1">&#39;english&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">language</span> <span class="o">=</span> <span class="s1">&#39;english&#39;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;babel&#39;</span><span class="p">]:</span>
                <span class="n">babel_prefix</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">addto</span><span class="se">\\</span><span class="s1">captions</span><span class="si">%s</span><span class="s1">{&#39;</span> <span class="o">%</span> <span class="n">language</span>
                <span class="n">babel_suffix</span> <span class="o">=</span> <span class="s1">&#39;}&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">babel_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="n">babel_suffix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">return</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="se">\\</span><span class="s1">renewcommand{</span><span class="si">%s</span><span class="s1">}{</span><span class="si">%s</span><span class="s1">}</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">babel_prefix</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">definition</span><span class="p">,</span> <span class="n">babel_suffix</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">generate_numfig_format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">figure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">numfig_format</span><span class="p">[</span><span class="s1">&#39;figure&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">figure</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">def</span><span class="se">\\</span><span class="s1">fnum@figure{</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                       <span class="n">text_type</span><span class="p">(</span><span class="n">figure</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">definition</span> <span class="o">=</span> <span class="n">text_type</span><span class="p">(</span><span class="n">figure</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">babel_renewcommand</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">figurename&#39;</span><span class="p">,</span> <span class="n">definition</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">figure</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">makeatletter</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">def</span><span class="se">\\</span><span class="s1">fnum@figure{</span><span class="se">\\</span><span class="s1">figurename</span><span class="se">\\</span><span class="s1">thefigure</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                           <span class="n">text_type</span><span class="p">(</span><span class="n">figure</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">))</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">makeatother</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">numfig_format</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">def</span><span class="se">\\</span><span class="s1">fnum@table{</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                       <span class="n">text_type</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">definition</span> <span class="o">=</span> <span class="n">text_type</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">babel_renewcommand</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">tablename&#39;</span><span class="p">,</span> <span class="n">definition</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">makeatletter</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">def</span><span class="se">\\</span><span class="s1">fnum@table{</span><span class="se">\\</span><span class="s1">tablename</span><span class="se">\\</span><span class="s1">thetable</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                           <span class="n">text_type</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">))</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">makeatother</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">codeblock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">numfig_format</span><span class="p">[</span><span class="s1">&#39;code-block&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">codeblock</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">pass</span>  <span class="c1"># FIXME</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">SetupFloatingEnvironment{literal-block}{name=</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                       <span class="n">text_type</span><span class="p">(</span><span class="n">codeblock</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">table</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">pass</span>  <span class="c1"># FIXME</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">generate_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">collapsed</span><span class="p">):</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{theindex}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">def</span><span class="se">\\</span><span class="s1">bigletter#1{{</span><span class="se">\\</span><span class="s1">Large</span><span class="se">\\</span><span class="s1">sffamily#1}&#39;</span>
                       <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">nopagebreak</span><span class="se">\\</span><span class="s1">vspace{1mm}}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">letter</span><span class="p">,</span> <span class="n">entries</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">content</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">indexspace</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">bigletter{</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                           <span class="n">text_type</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                        <span class="k">continue</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">item {</span><span class="se">\\</span><span class="s1">texttt{</span><span class="si">%s</span><span class="s1">}}&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">entry</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
                        <span class="c1"># add &quot;extra&quot; info</span>
                        <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; </span><span class="se">\\</span><span class="s1">emph{(</span><span class="si">%s</span><span class="s1">)}&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, </span><span class="se">\\</span><span class="s1">pageref{</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                               <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">idescape</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">3</span><span class="p">])))</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{theindex}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># latex_domain_indices can be False/True or a list of index names</span>
        <span class="n">indices_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_domain_indices</span>
        <span class="k">if</span> <span class="n">indices_config</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">domains</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">indexcls</span> <span class="ow">in</span> <span class="n">domain</span><span class="o">.</span><span class="n">indices</span><span class="p">:</span>
                    <span class="n">indexname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">indexcls</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">indices_config</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">indexname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">indices_config</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="c1"># deprecated config value</span>
                    <span class="k">if</span> <span class="n">indexname</span> <span class="o">==</span> <span class="s1">&#39;py-modindex&#39;</span> <span class="ow">and</span> \
                       <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_use_modindex</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">content</span><span class="p">,</span> <span class="n">collapsed</span> <span class="o">=</span> <span class="n">indexcls</span><span class="p">(</span><span class="n">domain</span><span class="p">)</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">docnames</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">content</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\\</span><span class="s1">renewcommand{</span><span class="se">\\</span><span class="s1">indexname}{</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                               <span class="n">indexcls</span><span class="o">.</span><span class="n">localname</span><span class="p">)</span>
                    <span class="n">generate</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">collapsed</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotestack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collect_footnotes</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;docname&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_document</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># the first document is all the regular content ...</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BEGIN_DOC</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_document</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_document</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># ... and all others are the appendices</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\n\\</span><span class="s1">appendix</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_document</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;docname&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="s1">&#39;:doc&#39;</span><span class="p">))</span>
        <span class="c1"># &quot;- 1&quot; because the level is increased before the title is visited</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sectionlevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_sectionlevel</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">depart_document</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibitems</span><span class="p">:</span>
            <span class="n">widest_label</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibitems</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">widest_label</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bi</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">widest_label</span> <span class="o">=</span> <span class="n">bi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\n\\</span><span class="s1">begin{thebibliography}{</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">widest_label</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">bi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bibitems</span><span class="p">:</span>
                <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="n">bi</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">bi</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                          <span class="n">withdoc</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\\</span><span class="s1">bibitem[</span><span class="si">%s</span><span class="s1">]{</span><span class="si">%s</span><span class="s1">}{</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">bi</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">idescape</span><span class="p">(</span><span class="n">bi</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                  <span class="n">target</span><span class="p">,</span> <span class="n">bi</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\\</span><span class="s1">end{thebibliography}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibitems</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">visit_start_of_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># collect new footnotes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotestack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">collect_footnotes</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="c1"># also add a document target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_section_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;:doc&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">])</span>
        <span class="c1"># use default highlight settings for new file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlsettingstack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hlsettingstack</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">collect_footnotes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">footnotes_under</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">footnote</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">n</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">start_of_file</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">footnotes_under</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
                        <span class="k">yield</span> <span class="n">k</span>
        <span class="n">fnotes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">footnotes_under</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="n">num</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">newnode</span> <span class="o">=</span> <span class="n">collected_footnote</span><span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="o">.</span><span class="n">children</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
            <span class="n">fnotes</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">newnode</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">fnotes</span>

    <span class="k">def</span> <span class="nf">depart_start_of_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">footnotestack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlsettingstack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">visit_highlightlang</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hlsettingstack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;lang&#39;</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;linenothreshold&#39;</span><span class="p">]]</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_is_the_title</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sectionlevel</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ids&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_section_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">depart_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sectionlevel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sectionlevel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">top_sectionlevel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_problematic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;{\color{red}\bfseries{}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_problematic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">setbox0</span><span class="se">\\</span><span class="s1">vbox{</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{minipage}{0.95</span><span class="se">\\</span><span class="s1">linewidth}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{minipage}}</span><span class="se">\n</span><span class="s1">&#39;</span>
                         <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{center}</span><span class="se">\\</span><span class="s1">setlength{</span><span class="se">\\</span><span class="s1">fboxsep}{5pt}&#39;</span>
                         <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">shadowbox{</span><span class="se">\\</span><span class="s1">box0}</span><span class="se">\\</span><span class="s1">end{center}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">visit_sidebar</span> <span class="o">=</span> <span class="n">visit_topic</span>
    <span class="n">depart_sidebar</span> <span class="o">=</span> <span class="n">depart_topic</span>

    <span class="k">def</span> <span class="nf">visit_glossary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_glossary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_productionlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\\</span><span class="s1">begin{productionlist}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_production_list</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">depart_productionlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{productionlist}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_production_list</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">visit_production</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;tokenname&#39;</span><span class="p">]:</span>
            <span class="n">tn</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;tokenname&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="s1">&#39;grammar-token-&#39;</span> <span class="o">+</span> <span class="n">tn</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">production{</span><span class="si">%s</span><span class="s1">}{&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">tn</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">productioncont{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_production</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;transition&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">depart_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">seealso</span><span class="p">):</span>
            <span class="c1"># the environment already handles this</span>
            <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">this_is_the_title</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                          <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;document title is not a single Text node&#39;</span><span class="p">,</span>
                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">line</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]:</span>
                <span class="c1"># text needs to be escaped since it is inserted into</span>
                <span class="c1"># the output literally</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">this_is_the_title</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">section</span><span class="p">):</span>
            <span class="n">short</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">image</span><span class="p">):</span>
                <span class="n">short</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">clean_astext</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">())</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\</span><span class="si">%s%s</span><span class="s1">{&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sectionnames</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">sectionlevel</span><span class="p">],</span> <span class="n">short</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># just use &quot;subparagraph&quot;, it&#39;s not numbered anyway</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\</span><span class="si">%s%s</span><span class="s1">{&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sectionnames</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">short</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">restrict_footnote</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_section_ids</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_section_ids</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_section_ids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">topic</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">sidebar</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\textbf{&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n\n</span><span class="s1">\medskip</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Admonition</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">table</span><span class="p">):</span>
            <span class="c1"># Redirect body output until title is finished.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushbody</span><span class="p">([])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;encountered title node not in section, topic, table, &#39;</span>
                <span class="s1">&#39;admonition or sidebar&#39;</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">textbf{&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">depart_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">table</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">caption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popbody</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unrestrict_footnote</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_subtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">sidebar</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;~</span><span class="se">\\\\\n\\</span><span class="s1">textbf{&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n\\</span><span class="s1">smallskip</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_subtitle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">visit_desc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\\</span><span class="s1">begin{fulllineitems}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">depart_desc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">end{fulllineitems}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_desc_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="s1">&#39;objtype&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;describe&#39;</span> <span class="ow">and</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]:</span>
            <span class="n">hyper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hyper</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hyper</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">desc_parameterlist</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\pysiglinewithargsret{&#39;</span><span class="p">)</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\pysigline{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_desc_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_desc_addname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\code{&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">literal_whitespace</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">depart_desc_addname</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">literal_whitespace</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">visit_desc_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_desc_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_desc_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;{ $\rightarrow$ &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_desc_returns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_desc_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\bfcode{&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">literal_whitespace</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">depart_desc_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">literal_whitespace</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">visit_desc_parameterlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># close name, open parameterlist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}{&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_param</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">depart_desc_parameterlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># close parameterlist, open return annotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_desc_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_param</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">first_param</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">hasattr</span><span class="p">(</span><span class="s1">&#39;noemph&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\emph{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_desc_parameter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">hasattr</span><span class="p">(</span><span class="s1">&#39;noemph&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_desc_optional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\optional{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_desc_optional</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_desc_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\strong{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_desc_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_desc_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">):</span>
            <span class="c1"># avoid empty desc environment which causes a formatting bug</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_desc_content</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_seealso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\n\n\\</span><span class="s1">strong{</span><span class="si">%s</span><span class="s1">:}</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">admonitionlabels</span><span class="p">[</span><span class="s1">&#39;seealso&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">depart_seealso</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_rubric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span> <span class="ow">in</span> \
           <span class="p">(</span><span class="s1">&#39;Footnotes&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Footnotes&#39;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">paragraph{&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">depart_rubric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">visit_footnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_collected_footnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_footnote</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="s1">&#39;footnotetext&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">footnotetext[</span><span class="si">%s</span><span class="s1">]{&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">footnote[</span><span class="si">%s</span><span class="s1">]{&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;number&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">depart_collected_footnote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_footnote</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">visit_label</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">citation</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibitems</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibitems</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bibitems</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_tabular_col_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_table_colspec</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;spec&#39;</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsupportedError</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">: nested tables are not yet implemented.&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">line</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">longtable</span> <span class="o">=</span> <span class="s1">&#39;longtable&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablebody</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tableheaders</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Redirect body output until table is finished.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pushbody</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tablebody</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restrict_footnote</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">longtable</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">popbody</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">longtable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">caption</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n\\</span><span class="s1">begin{threeparttable}</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">capstart</span><span class="se">\\</span><span class="s1">caption{&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">caption</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">caption</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_table_ids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">anchor</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_table_ids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">longtable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">begin{longtable}&#39;</span><span class="p">)</span>
            <span class="n">endmacro</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{longtable}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_verbatim</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">begin{tabular}&#39;</span><span class="p">)</span>
            <span class="n">endmacro</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{tabular}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colspec</span><span class="p">:</span>
            <span class="c1"># if the user has given us tabularcolumns, accept them and use</span>
            <span class="c1"># tabulary nevertheless</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">begin{tabular}&#39;</span><span class="p">)</span>
            <span class="n">endmacro</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{tabular}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">begin{tabulary}{</span><span class="se">\\</span><span class="s1">linewidth}&#39;</span><span class="p">)</span>
            <span class="n">endmacro</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{tabulary}</span><span class="se">\n\n</span><span class="s1">&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colspec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colspec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span><span class="p">:</span>
                <span class="n">colwidth</span> <span class="o">=</span> <span class="mf">0.95</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colcount</span>
                <span class="n">colspec</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;p{</span><span class="si">%.3f</span><span class="se">\\</span><span class="s1">linewidth}|&#39;</span> <span class="o">%</span> <span class="n">colwidth</span><span class="p">)</span> <span class="o">*</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colcount</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{|&#39;</span> <span class="o">+</span> <span class="n">colspec</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">longtable</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{|&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;l|&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colcount</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{|&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="s1">&#39;L|&#39;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colcount</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">longtable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">caption</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\\</span><span class="s1">caption{&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">caption</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">caption</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">caption</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_table_ids</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_table_ids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\\\\\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">longtable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">hline</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableheaders</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">endfirsthead</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">multicolumn{</span><span class="si">%s</span><span class="s1">}{c}</span><span class="si">%%</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colcount</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;{{\textsf{\tablename\ \thetable{} -- </span><span class="si">%s</span><span class="s1">}}} </span><span class="se">\\</span><span class="s1">&#39;</span>
                             <span class="o">%</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;continued from previous page&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">hline</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableheaders</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">endhead</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\hline \multicolumn{</span><span class="si">%s</span><span class="s1">}{|r|}{{\textsf{</span><span class="si">%s</span><span class="s1">}}} </span><span class="se">\\</span><span class="s1"> \hline&#39;</span>
                             <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colcount</span><span class="p">,</span>
                                <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Continued on next page&#39;</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">endfoot</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">endlastfoot</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">hline</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tableheaders</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tablebody</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">endmacro</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">longtable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">caption</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{threeparttable}</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unrestrict_footnote</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tablebody</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">visit_colspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colcount</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">depart_colspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_tgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_tgroup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_thead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">had_head</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_table_colspec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colspec</span> <span class="o">=</span> <span class="s1">&#39;{</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_table_colspec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_table_colspec</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c1"># Redirect head output until header is finished. see visit_tbody.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tableheaders</span>

    <span class="k">def</span> <span class="nf">depart_thead</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_tbody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">had_head</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visit_thead</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablebody</span>

    <span class="k">def</span> <span class="nf">depart_tbody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirow</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">visit_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirow</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">depart_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\\\\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remember_multirow</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">linestart</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">colcount</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">linestart</span> <span class="o">!=</span> <span class="n">col</span><span class="p">:</span>
                        <span class="n">linerange</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">linestart</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cline{&#39;</span> <span class="o">+</span> <span class="n">linerange</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">)</span>
                    <span class="n">linestart</span> <span class="o">=</span> <span class="n">col</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">linestart</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">linestart</span> <span class="o">&lt;=</span> <span class="n">col</span><span class="p">:</span>
                <span class="n">linerange</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">linestart</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cline{&#39;</span> <span class="o">+</span> <span class="n">linerange</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">hline&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">visit_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirow</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">extracols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; \multicolumn{&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">extracols</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}{|l|}{}&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">+=</span> <span class="n">extracols</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &amp; &#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &amp; &#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;morecols&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; \multicolumn{&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;morecols&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}{|l|}{&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}{l|}{&#39;</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">+=</span> <span class="s1">&#39;}&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;morerows&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; \multirow{&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;morerows&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}{*}{&#39;</span><span class="p">)</span>
            <span class="n">context</span> <span class="o">+=</span> <span class="s1">&#39;}&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirow</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;morerows&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;morecols&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;morerows&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;morecols&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">+=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;morecols&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;morecols&#39;</span> <span class="ow">in</span> <span class="n">node</span> <span class="ow">or</span> <span class="s1">&#39;morerows&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">)</span> <span class="ow">and</span>
           <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_merged_cell</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">literal_whitespace</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">eqparbox{</span><span class="si">%d</span><span class="s1">}{</span><span class="se">\\</span><span class="s1">vspace{.5</span><span class="se">\\</span><span class="s1">baselineskip}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">id</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pushbody</span><span class="p">([])</span>
            <span class="n">context</span> <span class="o">+=</span> <span class="s1">&#39;}&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">thead</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">textsf{</span><span class="se">\\</span><span class="s1">relax &#39;</span><span class="p">)</span>
                <span class="n">context</span> <span class="o">+=</span> <span class="s1">&#39;}&#39;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirow</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirow</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">context</span> <span class="o">+=</span> <span class="s1">&#39; &amp; &#39;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">extracols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remember_multirowcol</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span><span class="p">]</span>
                <span class="n">context</span> <span class="o">+=</span> <span class="s1">&#39; \multicolumn{&#39;</span>
                <span class="n">context</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">extracols</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">context</span> <span class="o">+=</span> <span class="s1">&#39;}{l|}{}&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">col</span> <span class="o">+=</span> <span class="n">extracols</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_merged_cell</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_merged_cell</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">literal_whitespace</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">body</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">popbody</span><span class="p">()</span>
            <span class="c1"># Remove empty lines from top of merged cell</span>
            <span class="k">while</span> <span class="n">body</span> <span class="ow">and</span> <span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="n">body</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">body</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">u&#39;(?&lt;!~</span><span class="se">\\\\\\\\</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">u&#39;~</span><span class="se">\\\\\\\\\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>  <span class="c1"># escape return code</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>  <span class="c1"># header</span>

    <span class="k">def</span> <span class="nf">visit_acks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># this is a list in the source, but should be rendered as a</span>
        <span class="c1"># comma-separated list here</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">n</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
                                   <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_bullet_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compact_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{itemize}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">depart_bullet_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">compact_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{itemize}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_enumerated_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{enumerate}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;start&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">setcounter{enumi}{</span><span class="si">%d</span><span class="s1">}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">depart_enumerated_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{enumerate}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_list_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># Append &quot;{}&quot; in case the next character is &quot;[&quot;, which would break</span>
        <span class="c1"># LaTeX&#39;s list environment (no numbering and the &quot;[&quot; is not printed).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\item {} &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_list_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_definition_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{description}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">depart_definition_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{description}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_definition_list_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_definition_list_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_term</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="s1">&#39;}] </span><span class="se">\\</span><span class="s1">leavevmode&#39;</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ids&#39;</span><span class="p">):</span>
            <span class="n">ctx</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">item[{&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restrict_footnote</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unrestrict_footnote</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_term</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">visit_termsep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{[}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_classifier</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{]}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_field_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{quote}</span><span class="se">\\</span><span class="s1">begin{description}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">depart_field_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{description}</span><span class="se">\\</span><span class="s1">end{quote}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="n">visit_field_name</span> <span class="o">=</span> <span class="n">visit_term</span>
    <span class="n">depart_field_name</span> <span class="o">=</span> <span class="n">depart_term</span>

    <span class="n">visit_field_body</span> <span class="o">=</span> <span class="n">visit_definition</span>
    <span class="n">depart_field_body</span> <span class="o">=</span> <span class="n">depart_definition</span>

    <span class="k">def</span> <span class="nf">visit_paragraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_paragraph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_centered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">begin{center}&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">depart_centered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">end{center}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_hlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># for now, we don&#39;t support a more compact list format</span>
        <span class="c1"># don&#39;t add individual itemize environments, but one for all columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compact_list</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{itemize}</span><span class="se">\\</span><span class="s1">setlength{</span><span class="se">\\</span><span class="s1">itemsep}{0pt}&#39;</span>
                         <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">setlength{</span><span class="se">\\</span><span class="s1">parskip}{0pt}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">depart_hlist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compact_list</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{itemize}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_hlistcol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_hlistcol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">latex_image_length</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width_str</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;(\d*\.?\d*)\s*(\S*)&#39;</span><span class="p">,</span> <span class="n">width_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="c1"># fallback</span>
            <span class="k">return</span> <span class="n">width_str</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">width_str</span>
        <span class="n">amount</span><span class="p">,</span> <span class="n">unit</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">unit</span> <span class="ow">or</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;px&quot;</span><span class="p">:</span>
            <span class="c1"># pixels: let LaTeX alone</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">elif</span> <span class="n">unit</span> <span class="o">==</span> <span class="s2">&quot;%&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%.3f</span><span class="se">\\</span><span class="s2">linewidth&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="nf">is_inline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check whether a node represents an inline element.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">TextElement</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span>
        <span class="n">pre</span> <span class="o">=</span> <span class="p">[]</span>                        <span class="c1"># in reverse order</span>
        <span class="n">post</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">include_graphics_options</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">is_inline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_inline</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;scale&#39;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="c1"># Could also be done with ``scale`` option to</span>
            <span class="c1"># ``\includegraphics``; doing it this way for consistency.</span>
            <span class="n">pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">scalebox{</span><span class="si">%f</span><span class="s1">}{&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;scale&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">,))</span>
            <span class="n">post</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;width&#39;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_image_length</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">w</span><span class="p">:</span>
                <span class="n">include_graphics_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;width=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">w</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;height&#39;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">latex_image_length</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;height&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">h</span><span class="p">:</span>
                <span class="n">include_graphics_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;height=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">h</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;align&#39;</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">align_prepost</span> <span class="o">=</span> <span class="p">{</span>
                <span class="c1"># By default latex aligns the top of an image.</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;top&#39;</span><span class="p">):</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;middle&#39;</span><span class="p">):</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">raisebox{-0.5</span><span class="se">\\</span><span class="s1">height}{&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;bottom&#39;</span><span class="p">):</span> <span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">raisebox{-</span><span class="se">\\</span><span class="s1">height}{&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;center&#39;</span><span class="p">):</span> <span class="p">(</span><span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">hspace*{</span><span class="se">\\</span><span class="s1">fill}&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">hspace*{</span><span class="se">\\</span><span class="s1">fill}}&#39;</span><span class="p">),</span>
                <span class="c1"># These 2 don&#39;t exactly do the right thing.  The image should</span>
                <span class="c1"># be floated alongside the paragraph.  See</span>
                <span class="c1"># http://www.w3.org/TR/html4/struct/objects.html#adef-align-IMG</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;left&#39;</span><span class="p">):</span> <span class="p">(</span><span class="s1">&#39;{&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">hspace*{</span><span class="se">\\</span><span class="s1">fill}}&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">):</span> <span class="p">(</span><span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">hspace*{</span><span class="se">\\</span><span class="s1">fill}&#39;</span><span class="p">,</span> <span class="s1">&#39;}&#39;</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">align_prepost</span><span class="p">[</span><span class="n">is_inline</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;align&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">post</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">align_prepost</span><span class="p">[</span><span class="n">is_inline</span><span class="p">,</span> <span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;align&#39;</span><span class="p">]][</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_inline</span><span class="p">:</span>
            <span class="n">pre</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">post</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">pre</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">images</span><span class="p">:</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># missing image!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_missing_images</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">uri</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;://&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># ignore remote images</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">pre</span><span class="p">)</span>
        <span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">include_graphics_options</span><span class="p">:</span>
            <span class="n">options</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">include_graphics_options</span><span class="p">)</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">uri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">includegraphics</span><span class="si">%s</span><span class="s1">{{</span><span class="si">%s</span><span class="s1">}</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_figure_ids</span><span class="p">:</span>
            <span class="n">ids</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_figure_ids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restrict_footnote</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="ow">and</span>
           <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nodes</span><span class="o">.</span><span class="n">image</span><span class="p">)</span> <span class="ow">and</span>
           <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ids&#39;</span><span class="p">]):</span>
            <span class="n">ids</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">anchor</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;width&#39;</span> <span class="ow">in</span> <span class="n">node</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;align&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{wrapfigure}{</span><span class="si">%s</span><span class="s1">}{</span><span class="si">%s</span><span class="s1">}</span><span class="se">\n\\</span><span class="s1">centering&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;align&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;right&#39;</span> <span class="ow">and</span> <span class="s1">&#39;r&#39;</span> <span class="ow">or</span> <span class="s1">&#39;l&#39;</span><span class="p">,</span>
                              <span class="n">node</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{wrapfigure}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;align&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span> <span class="ow">or</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;align&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;center&#39;</span><span class="p">):</span>
                <span class="c1"># centering does not add vertical space like center.</span>
                <span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">centering&#39;</span>
                <span class="n">align_end</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO non vertical space for other alignments.</span>
                <span class="n">align</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{flush</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;align&#39;</span><span class="p">]</span>
                <span class="n">align_end</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{flush</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="n">node</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="s1">&#39;align&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{figure}[</span><span class="si">%s</span><span class="s1">]</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">elements</span><span class="p">[</span><span class="s1">&#39;figure_align&#39;</span><span class="p">],</span> <span class="n">align</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">caption</span><span class="p">)</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">capstart</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span> <span class="o">+</span> <span class="n">align_end</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{figure}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_figure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unrestrict_footnote</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_caption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_caption</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_container_literal_block</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">needspace{</span><span class="se">\\</span><span class="s1">literalblockneedspace}&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">vspace{</span><span class="se">\\</span><span class="s1">literalblockcaptiontopvspace}&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">captionof{literal-block}{&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">caption{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_caption</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_caption</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">visit_legend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;{</span><span class="se">\\</span><span class="s1">small &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_legend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_admonition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">begin{notice}{note}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_admonition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{notice}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_make_visit_admonition</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">visit_admonition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\n\\</span><span class="s1">begin{notice}{</span><span class="si">%s</span><span class="s1">}{</span><span class="si">%s</span><span class="s1">:}&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">admonitionlabels</span><span class="p">[</span><span class="n">name</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">visit_admonition</span>

    <span class="k">def</span> <span class="nf">_depart_named_admonition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{notice}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">visit_attention</span> <span class="o">=</span> <span class="n">_make_visit_admonition</span><span class="p">(</span><span class="s1">&#39;attention&#39;</span><span class="p">)</span>
    <span class="n">depart_attention</span> <span class="o">=</span> <span class="n">_depart_named_admonition</span>
    <span class="n">visit_caution</span> <span class="o">=</span> <span class="n">_make_visit_admonition</span><span class="p">(</span><span class="s1">&#39;caution&#39;</span><span class="p">)</span>
    <span class="n">depart_caution</span> <span class="o">=</span> <span class="n">_depart_named_admonition</span>
    <span class="n">visit_danger</span> <span class="o">=</span> <span class="n">_make_visit_admonition</span><span class="p">(</span><span class="s1">&#39;danger&#39;</span><span class="p">)</span>
    <span class="n">depart_danger</span> <span class="o">=</span> <span class="n">_depart_named_admonition</span>
    <span class="n">visit_error</span> <span class="o">=</span> <span class="n">_make_visit_admonition</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
    <span class="n">depart_error</span> <span class="o">=</span> <span class="n">_depart_named_admonition</span>
    <span class="n">visit_hint</span> <span class="o">=</span> <span class="n">_make_visit_admonition</span><span class="p">(</span><span class="s1">&#39;hint&#39;</span><span class="p">)</span>
    <span class="n">depart_hint</span> <span class="o">=</span> <span class="n">_depart_named_admonition</span>
    <span class="n">visit_important</span> <span class="o">=</span> <span class="n">_make_visit_admonition</span><span class="p">(</span><span class="s1">&#39;important&#39;</span><span class="p">)</span>
    <span class="n">depart_important</span> <span class="o">=</span> <span class="n">_depart_named_admonition</span>
    <span class="n">visit_note</span> <span class="o">=</span> <span class="n">_make_visit_admonition</span><span class="p">(</span><span class="s1">&#39;note&#39;</span><span class="p">)</span>
    <span class="n">depart_note</span> <span class="o">=</span> <span class="n">_depart_named_admonition</span>
    <span class="n">visit_tip</span> <span class="o">=</span> <span class="n">_make_visit_admonition</span><span class="p">(</span><span class="s1">&#39;tip&#39;</span><span class="p">)</span>
    <span class="n">depart_tip</span> <span class="o">=</span> <span class="n">_depart_named_admonition</span>
    <span class="n">visit_warning</span> <span class="o">=</span> <span class="n">_make_visit_admonition</span><span class="p">(</span><span class="s1">&#39;warning&#39;</span><span class="p">)</span>
    <span class="n">depart_warning</span> <span class="o">=</span> <span class="n">_depart_named_admonition</span>

    <span class="k">def</span> <span class="nf">visit_versionmodified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_versionmodified</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">add_target</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>
            <span class="c1"># indexing uses standard LaTeX index markup, so the targets</span>
            <span class="c1"># will be generated differently</span>
            <span class="k">if</span> <span class="nb">id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;index-&#39;</span><span class="p">):</span>
                <span class="k">return</span>
            <span class="c1"># do not generate \phantomsection in \section{}</span>
            <span class="n">anchor</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="n">anchor</span><span class="p">))</span>

        <span class="c1"># postpone the labels until after the sectioning command</span>
        <span class="n">parindex</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span><span class="n">parindex</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="c1"># last node in parent, look at next after parent</span>
                <span class="c1"># (for section of equal level) if it exists</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="nb">next</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">[</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">section</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refid&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">next_section_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_section_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">])</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">figure</span><span class="p">):</span>
                <span class="c1"># labels for figures go in the figure body, not before</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refid&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">next_figure_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_figure_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">])</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">table</span><span class="p">):</span>
                <span class="c1"># same for tables, but only if they have a caption</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">next</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">title</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refid&#39;</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">next_table_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">next_table_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">])</span>
                        <span class="k">return</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">next</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">container</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">next</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;literal_block&#39;</span><span class="p">):</span>
                <span class="c1"># same for literal_block, but only if they have a caption</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refid&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">next_literal_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_literal_ids</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">])</span>
                <span class="k">return</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="s1">&#39;refuri&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refid&#39;</span><span class="p">):</span>
            <span class="n">add_target</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]:</span>
            <span class="n">add_target</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_attribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">begin{flushright}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;---&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_attribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">end{flushright}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">scre</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;;\s*&#39;</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;inline&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">string</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">ismain</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">ismain</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="s1">&#39;|textbf&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">scre</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">string</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\index{</span><span class="si">%s%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;pair&#39;</span><span class="p">:</span>
                    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">split_into</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;pair&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\index{</span><span class="si">%s</span><span class="s1">!</span><span class="si">%s%s</span><span class="s1">}\index{</span><span class="si">%s</span><span class="s1">!</span><span class="si">%s%s</span><span class="s1">}&#39;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>  <span class="n">p2</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;triple&#39;</span><span class="p">:</span>
                    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">split_into</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;triple&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s1">r&#39;\index{</span><span class="si">%s</span><span class="s1">!</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s%s</span><span class="s1">}\index{</span><span class="si">%s</span><span class="s1">!</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s%s</span><span class="s1">}&#39;</span>
                        <span class="s1">r&#39;\index{</span><span class="si">%s</span><span class="s1">!</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s%s</span><span class="s1">}&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>  <span class="n">p2</span><span class="p">,</span> <span class="n">p3</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>  <span class="n">p3</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">m</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;see&#39;</span><span class="p">:</span>
                    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">split_into</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;see&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\index{</span><span class="si">%s</span><span class="s1">|see{</span><span class="si">%s</span><span class="s1">}}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">))</span>
                <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;seealso&#39;</span><span class="p">:</span>
                    <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">split_into</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;seealso&#39;</span><span class="p">,</span> <span class="n">string</span><span class="p">)]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\index{</span><span class="si">%s</span><span class="s1">|see{</span><span class="si">%s</span><span class="s1">}}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="s1">&#39;unknown index entry type </span><span class="si">%s</span><span class="s1"> found&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;latex&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">())</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ids&#39;</span><span class="p">):</span>
                <span class="n">anchor</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_caption</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="n">anchor</span><span class="p">)</span>
        <span class="n">uri</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refuri&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uri</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refid&#39;</span><span class="p">):</span>
            <span class="n">uri</span> <span class="o">=</span> <span class="s1">&#39;%&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">uri</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">URI_SCHEMES</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">href{</span><span class="si">%s</span><span class="s1">}{&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_uri</span><span class="p">(</span><span class="n">uri</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">):</span>
            <span class="c1"># references to labels in the same document</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">uri</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperlink</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\emph{&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_show_pagerefs</span> <span class="ow">and</span> <span class="ow">not</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_production_list</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}}} (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperpageref</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}}}&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">uri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">):</span>
            <span class="c1"># references to documents or labels inside documents</span>
            <span class="n">hashindex</span> <span class="o">=</span> <span class="n">uri</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">hashindex</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># reference to the document</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">uri</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="s1">&#39;::doc&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># reference to a label</span>
                <span class="nb">id</span> <span class="o">=</span> <span class="n">uri</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperlink</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\emph{&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;attributes&#39;</span><span class="p">)</span> <span class="ow">and</span> \
               <span class="s1">&#39;std-term&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="p">[]):</span>
                <span class="c1"># don&#39;t add a pageref for glossary terms</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}}}&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">latex_show_pagerefs</span> <span class="ow">and</span> <span class="ow">not</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">in_production_list</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}}} (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperpageref</span><span class="p">(</span><span class="nb">id</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}}}&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;unusable reference target found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">uri</span><span class="p">,</span>
                              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">line</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">visit_number_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refid&#39;</span><span class="p">):</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;refid&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refuri&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span>

        <span class="n">ref</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">ref{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">idescape</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">text_type</span><span class="p">(</span><span class="n">title</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">hyperref</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">hyperref[</span><span class="si">%s</span><span class="s1">]{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">idescape</span><span class="p">(</span><span class="nb">id</span><span class="p">),</span> <span class="n">title</span> <span class="o">%</span> <span class="n">ref</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hyperref</span><span class="p">)</span>

        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_download_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_download_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_pending_xref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_pending_xref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_emphasis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\emph{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_emphasis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_literal_emphasis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\emph{\texttt{&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">depart_literal_emphasis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">visit_strong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\textbf{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_strong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_literal_strong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\textbf{\texttt{&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">depart_literal_strong</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}}&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">-=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">visit_abbreviation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">abbr</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\textsc{&#39;</span><span class="p">)</span>
        <span class="c1"># spell out the explanation once</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">hasattr</span><span class="p">(</span><span class="s1">&#39;explanation&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">abbr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handled_abbrs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;} (</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;explanation&#39;</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handled_abbrs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">abbr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_abbreviation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">visit_title_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\emph{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_title_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_citation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># TODO maybe use cite bibitems</span>
        <span class="c1"># bibitem: [citelabel, citetext, docname, citeid]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibitems</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">depart_citation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">size</span><span class="p">:])</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="n">size</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bibitems</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">visit_citation_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># This is currently never encountered, since citation_reference nodes</span>
        <span class="c1"># are already replaced by pending_xref nodes in the environment.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">cite{</span><span class="si">%s</span><span class="s1">}&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">idescape</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()))</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_literal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\texttt{&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\code{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_literal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_footnote_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">footnode</span><span class="p">,</span> <span class="n">used</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnotestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">num</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>
        <span class="c1"># if a footnote has been inserted once, it shouldn&#39;t be repeated</span>
        <span class="c1"># by the next reference</span>
        <span class="k">if</span> <span class="n">used</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_term</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">protect</span><span class="se">\\</span><span class="s1">footnotemark[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">footnotemark[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">footnote_restricted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">footnotestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">num</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">protect</span><span class="se">\\</span><span class="s1">footnotemark[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">num</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pending_footnotes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">footnode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">footnotestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">num</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">footnode</span><span class="o">.</span><span class="n">walkabout</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipChildren</span>

    <span class="k">def</span> <span class="nf">depart_footnote_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_literal_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_footnote</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">UnsupportedError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">: literal blocks in footnotes are &#39;</span>
                                   <span class="s1">&#39;not supported by LaTeX&#39;</span> <span class="o">%</span>
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">line</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">rawsource</span> <span class="o">!=</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">():</span>
            <span class="c1"># most probably a parsed-literal block -- don&#39;t highlight</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{alltt}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
            <span class="n">lang</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlsettingstack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">linenos</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlsettingstack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="n">highlight_args</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;highlight_args&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="s1">&#39;language&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="c1"># code-block directives</span>
                <span class="n">lang</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;language&#39;</span><span class="p">]</span>
                <span class="n">highlight_args</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">if</span> <span class="s1">&#39;linenos&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="n">linenos</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;linenos&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lang</span> <span class="ow">is</span> <span class="bp">self</span><span class="o">.</span><span class="n">hlsettingstack</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
                <span class="c1"># only pass highlighter options for original language</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">highlight_options</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">opts</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">def</span> <span class="nf">warner</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">line</span><span class="p">))</span>
            <span class="n">hlcode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">highlighter</span><span class="o">.</span><span class="n">highlight_block</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">lang</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="n">opts</span><span class="p">,</span>
                                                      <span class="n">warn</span><span class="o">=</span><span class="n">warner</span><span class="p">,</span> <span class="n">linenos</span><span class="o">=</span><span class="n">linenos</span><span class="p">,</span>
                                                      <span class="o">**</span><span class="n">highlight_args</span><span class="p">)</span>
            <span class="c1"># workaround for Unicode issue</span>
            <span class="n">hlcode</span> <span class="o">=</span> <span class="n">hlcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">u&#39;€&#39;</span><span class="p">,</span> <span class="s1">u&#39;@texteuro[]&#39;</span><span class="p">)</span>
            <span class="c1"># must use original Verbatim environment and &quot;tabular&quot; environment</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
                <span class="n">hlcode</span> <span class="o">=</span> <span class="n">hlcode</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{Verbatim}&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{OriginalVerbatim}&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_verbatim</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="c1"># get consistent trailer</span>
            <span class="n">hlcode</span> <span class="o">=</span> <span class="n">hlcode</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()[:</span><span class="o">-</span><span class="mi">14</span><span class="p">]</span>  <span class="c1"># strip \end{Verbatim}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">hlcode</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{</span><span class="si">%s</span><span class="s1">Verbatim}</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                             <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">and</span> <span class="s1">&#39;Original&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">depart_literal_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">end{alltt}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">visit_doctest_block</span> <span class="o">=</span> <span class="n">visit_literal_block</span>
    <span class="n">depart_doctest_block</span> <span class="o">=</span> <span class="n">depart_literal_block</span>

    <span class="k">def</span> <span class="nf">visit_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;\item[] &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_line_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">line_block</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">item[]</span><span class="se">\n</span><span class="s1">&#39;</span>
                             <span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{DUlineblock}{</span><span class="se">\\</span><span class="s1">DUlineblockindent}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n\\</span><span class="s1">begin{DUlineblock}{0em}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">depart_line_block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{DUlineblock}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_block_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># If the block quote contains a single object and that object</span>
        <span class="c1"># is a list, then generate a list not a block quote.</span>
        <span class="c1"># This lets us indent lists.</span>
        <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">enumerated_list</span><span class="p">):</span>
                <span class="n">done</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{quote}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">depart_block_quote</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">child</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">)</span> <span class="ow">or</span> \
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">enumerated_list</span><span class="p">):</span>
                <span class="n">done</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{quote}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="c1"># option node handling copied from docutils&#39; latex writer</span>

    <span class="k">def</span> <span class="nf">visit_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="c1"># this is not the first option</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># flag that the first option is done.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">visit_option_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The delimiter betweeen an option and its argument.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delimiter&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">depart_option_argument</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_option_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">item [&#39;</span><span class="p">)</span>
        <span class="c1"># flag for first option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_option_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>  <span class="c1"># the flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;] &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_option_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">begin{optionlist}{3cm}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">has_problematic</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">depart_option_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">end{optionlist}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_option_list_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_option_list_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_option_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">ostring</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">ostring</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_superscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;$^{</span><span class="se">\\</span><span class="s1">text{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_superscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}}$&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_subscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;$_{</span><span class="se">\\</span><span class="s1">text{&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_subscript</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}}$&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_substitution_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_substitution_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_inline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">classes</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;menuselection&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;guilabel&#39;</span><span class="p">]]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\emph{&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">classes</span> <span class="ow">in</span> <span class="p">[[</span><span class="s1">&#39;accelerator&#39;</span><span class="p">]]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\underline{&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">classes</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_title</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">r&#39;\DUspan{</span><span class="si">%s</span><span class="s1">}{&#39;</span> <span class="o">%</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">classes</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;}&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_inline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">visit_generated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_generated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_compound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_compound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;literal_block&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_container_literal_block</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">ids</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_literal_ids</span><span class="p">:</span>
                <span class="n">ids</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]:</span>
                <span class="n">ids</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hypertarget</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_literal_ids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_container</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;literal_block&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_container_literal_block</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">visit_decoration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_decoration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># docutils-generated elements that we don&#39;t support</span>

    <span class="k">def</span> <span class="nf">visit_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_footer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_docinfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="c1"># text handling</span>

    <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text_type</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">translate</span><span class="p">(</span><span class="n">tex_escape_map</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">literal_whitespace</span><span class="p">:</span>
            <span class="c1"># Insert a blank before the newline, to avoid</span>
            <span class="c1"># ! LaTeX Error: There&#39;s no line here to end.</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">u&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">u&#39;~</span><span class="se">\\\\\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">u&#39; &#39;</span><span class="p">,</span> <span class="s1">u&#39;~&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">u&#39;-{-}&#39;</span><span class="p">)</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&#39;&quot;</span><span class="p">,</span> <span class="s2">u&quot;&#39;{&#39;}&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="k">def</span> <span class="nf">encode_uri</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="c1"># in \href, the tilde is allowed and must be represented literally</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">textasciitilde{}&#39;</span><span class="p">,</span> <span class="s1">&#39;~&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_Text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_contractions</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">educate_quotes_latex</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">depart_Text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">visit_comment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_meta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="c1"># only valid for HTML</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="k">def</span> <span class="nf">visit_system_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">depart_system_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">visit_math</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;using &quot;math&quot; markup without a Sphinx math extension &#39;</span>
                          <span class="s1">&#39;active, please use one of the math extensions &#39;</span>
                          <span class="s1">&#39;described at http://sphinx-doc.org/ext/math.html&#39;</span><span class="p">,</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">curfilestack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">node</span><span class="o">.</span><span class="n">line</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipNode</span>

    <span class="n">visit_math_block</span> <span class="o">=</span> <span class="n">visit_math</span>

    <span class="k">def</span> <span class="nf">unknown_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Unknown node: &#39;</span> <span class="o">+</span> <span class="n">node</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../_static/copybutton.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>